#!/usr/bin/env python3
"""
SCA - Security Control Agent CLI
Production-grade v1 unified entrypoint
"""

import argparse
import os
import subprocess
import sys
from pathlib import Path


def get_script_dir():
    """Get the directory containing this script."""
    return Path(__file__).parent.resolve()


def get_agent_dir():
    """Resolve agent directory (where SCA is installed)."""
    script_dir = get_script_dir()
    # Assume script is in <agent>/bin/sca
    return script_dir.parent


def merge_env_and_args(args, env_var, arg_value):
    """Merge environment variable with CLI argument (CLI wins)."""
    if arg_value:
        return arg_value
    return os.environ.get(env_var, "")


def main():
    parser = argparse.ArgumentParser(
        prog="sca",
        description="Security Control Agent - Read-only, invariant-driven security auditing",
        epilog="For more help: sca <command> --help",
    )

    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # Common arguments for all commands
    common = argparse.ArgumentParser(add_help=False)
    common.add_argument("--repo", default=".", help="Repository root (default: current dir)")
    common.add_argument("--ctrl-dir", help="Control directory (default: <repo>/sec-ctrl or $SEC_CTRL_DIR)")
    common.add_argument("--agent-dir", help="SCA agent location (default: auto-detect)")

    # sca audit
    audit_parser = subparsers.add_parser("audit", parents=[common], help="Run security audit")
    audit_parser.add_argument("--readonly-agent", dest="readonly_agent", action="store_true", default=True,
                              help="Enforce agent immutability (default: on)")
    audit_parser.add_argument("--no-readonly-agent", dest="readonly_agent", action="store_false",
                              help="Disable agent immutability check")
    audit_parser.add_argument("--format", choices=["md", "json", "both"], default="both",
                              help="Output format (default: both)")
    audit_parser.add_argument("--profile", choices=["baseline", "web", "crypto", "llm", "all"], default="all",
                              help="Invariant profile (default: all)")
    audit_parser.add_argument("--enable-deps", action="store_true", help="Run dependency scanners")
    audit_parser.add_argument("--incremental", action="store_true", help="Skip if repo unchanged")
    audit_parser.add_argument("--verbose", action="store_true", help="Show detailed progress")

    # Filtering options
    audit_parser.add_argument("--exclude-standards", help="Exclude standards (comma-separated: OWASP,NIST,PCI-DSS,CWE,SCA)")
    audit_parser.add_argument("--include-standards", help="Include only these standards (comma-separated)")
    audit_parser.add_argument("--severity-min", choices=["CRITICAL", "HIGH", "MEDIUM", "LOW"],
                              help="Minimum severity level")
    audit_parser.add_argument("--exclude-severity", help="Exclude severities (comma-separated)")
    audit_parser.add_argument("--interactive", action="store_true", help="Launch interactive suppression after audit")

    # sca scope
    scope_parser = subparsers.add_parser("scope", parents=[common], help="Print file scope")
    scope_parser.add_argument("--format", choices=["paths", "stats"], default="paths",
                              help="Output mode (default: paths)")

    # sca diff
    diff_parser = subparsers.add_parser("diff", parents=[common], help="Compare reports (drift analysis)")
    diff_parser.add_argument("--format", choices=["summary", "detailed"], default="summary",
                              help="Output format (default: summary)")

    # sca bootstrap
    bootstrap_parser = subparsers.add_parser("bootstrap", parents=[common], help="Initialize sec-ctrl/ directory")
    bootstrap_parser.add_argument("--force", action="store_true", help="Overwrite existing ctrl-dir")

    # sca suppress
    suppress_parser = subparsers.add_parser("suppress", parents=[common], help="Interactive finding suppression")
    suppress_parser.add_argument("--report", help="Path to audit report JSON file (default: latest)")
    suppress_parser.add_argument("--batch", help="Batch suppress from file (format: ID|Category|Reason)")
    suppress_parser.add_argument("--auto-commit", action="store_true", help="Auto-commit changes to OVERRIDE.md")
    suppress_parser.add_argument("--non-interactive", action="store_true", help="Batch mode only, no prompts")

    # sca create-tickets
    tickets_parser = subparsers.add_parser("create-tickets", parents=[common],
                                           help="Create GitHub issues or Jira tickets from findings")
    tickets_parser.add_argument("--report", help="Path to audit report JSON (default: latest)")
    tickets_parser.add_argument("--platform", choices=["github", "jira"], default="github",
                                help="Platform: github or jira (default: github)")
    tickets_parser.add_argument("--env-file", default=".env", help="Environment file with credentials (default: .env)")
    tickets_parser.add_argument("--severity-min", choices=["CRITICAL", "HIGH", "MEDIUM", "LOW"], default="HIGH",
                                help="Minimum severity for ticket creation (default: HIGH)")
    tickets_parser.add_argument("--dry-run", action="store_true", help="Preview without creating tickets")
    tickets_parser.add_argument("--create-all", action="store_true", help="Create tickets even if they already exist")

    # Parse args
    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(0)

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(3)

    # Resolve paths with env var fallback
    agent_dir = merge_env_and_args(args, "SEC_AUDIT_AGENT_HOME", getattr(args, "agent_dir", None))
    if not agent_dir:
        agent_dir = str(get_agent_dir())

    ctrl_dir = merge_env_and_args(args, "SEC_CTRL_DIR", getattr(args, "ctrl_dir", None))

    # Build command
    script_name_map = {
        "audit": "sec-audit.sh",
        "scope": "repo-scope.sh",
        "diff": "sec-diff.sh",
        "bootstrap": "sec-bootstrap.sh",
        "suppress": "sca-suppress.sh",
        "create-tickets": "sca-create-tickets.sh",
    }

    script_name = script_name_map.get(args.command)
    if not script_name:
        print(f"[ERROR] Unknown command: {args.command}", file=sys.stderr)
        sys.exit(3)

    script_path = get_script_dir() / script_name
    if not script_path.exists():
        print(f"[ERROR] Script not found: {script_path}", file=sys.stderr)
        sys.exit(5)

    # Build command arguments
    cmd = [str(script_path)]
    cmd.extend(["--repo", args.repo])

    if ctrl_dir:
        cmd.extend(["--ctrl-dir", ctrl_dir])

    if agent_dir:
        cmd.extend(["--agent-dir", agent_dir])

    # Command-specific args
    if args.command == "audit":
        if args.readonly_agent:
            cmd.append("--readonly-agent")
        else:
            cmd.append("--no-readonly-agent")

        cmd.extend(["--format", args.format])

        if args.enable_deps:
            cmd.append("--enable-deps")

        if args.incremental:
            cmd.append("--incremental")

        if args.verbose:
            cmd.append("--verbose")

        # Filtering flags
        if getattr(args, "exclude_standards", None):
            cmd.extend(["--exclude-standards", args.exclude_standards])

        if getattr(args, "include_standards", None):
            cmd.extend(["--include-standards", args.include_standards])

        if getattr(args, "severity_min", None):
            cmd.extend(["--severity-min", args.severity_min])

        if getattr(args, "exclude_severity", None):
            cmd.extend(["--exclude-severity", args.exclude_severity])

        if getattr(args, "interactive", False):
            cmd.append("--interactive")

    elif args.command == "scope":
        cmd.extend(["--format", args.format])

    elif args.command == "diff":
        cmd.extend(["--format", args.format])

    elif args.command == "bootstrap":
        if args.force:
            cmd.append("--force")

    elif args.command == "suppress":
        if getattr(args, "report", None):
            cmd.extend(["--report", args.report])

        if getattr(args, "batch", None):
            cmd.extend(["--batch", args.batch])

        if getattr(args, "auto_commit", False):
            cmd.append("--auto-commit")

        if getattr(args, "non_interactive", False):
            cmd.append("--non-interactive")

    elif args.command == "create-tickets":
        if getattr(args, "report", None):
            cmd.extend(["--report", args.report])

        cmd.extend(["--platform", args.platform])

        if getattr(args, "env_file", None):
            cmd.extend(["--env-file", args.env_file])

        if getattr(args, "severity_min", None):
            cmd.extend(["--severity-min", args.severity_min])

        if getattr(args, "dry_run", False):
            cmd.append("--dry-run")

        if getattr(args, "create_all", False):
            cmd.append("--create-all")

    # Execute
    try:
        result = subprocess.run(cmd, check=False)
        sys.exit(result.returncode)
    except FileNotFoundError:
        print(f"[ERROR] Failed to execute: {script_path}", file=sys.stderr)
        sys.exit(5)
    except KeyboardInterrupt:
        print("\n[INFO] Interrupted by user", file=sys.stderr)
        sys.exit(130)


if __name__ == "__main__":
    main()
